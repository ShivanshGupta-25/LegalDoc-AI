{% extends "base.html" %}
{% block content %}
<h2>ðŸ“„ Original Document</h2>
<div class="border p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
  <pre>{{ original }}</pre>
</div>

<h2 class="mt-4">âœ… Simplified Version ({{ chosen_language }})</h2>
<div class="border p-3 bg-white">
  <!-- safe rendering of markdown-to-HTML -->
  {{ simplified|safe }}
</div>

<hr>

<h2>ðŸ¤– Ask Questions About This Document</h2>

<!-- Chatbox -->
<div id="chatbox" class="border p-3 bg-light" style="height:300px; overflow-y:auto;"></div>

<!-- Language selector + input -->
<div class="input-group mt-3">
  <select id="chatLanguage" class="form-select" style="max-width: 150px;">
    <option value="auto" selected>Auto</option>
    <option value="en">English</option>
    <option value="hi">Hindi</option>
  </select>
  <input type="text" id="userInput" class="form-control" placeholder="Type your question...">
  <button class="btn btn-primary" onclick="askQuestion()">Ask</button>
</div>

<!-- Upload new doc -->
<a href="/" class="btn btn-secondary mt-3">Upload Another</a>

<script>
async function askQuestion() {
  let input = document.getElementById("userInput").value.trim();
  let chatLang = document.getElementById("chatLanguage").value;
  if (!input) return;

  let chatbox = document.getElementById("chatbox");
  chatbox.innerHTML += `<div class="p-2 mb-2 bg-primary text-white rounded"><b>You:</b> ${input}</div>`;
  chatbox.innerHTML += `<div id="thinking" class="p-2 mb-2 bg-light text-muted rounded"><i>AI is thinking...</i></div>`;
  chatbox.scrollTop = chatbox.scrollHeight;

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question: input, chat_language: chatLang })
    });
    const data = await res.json();

    // Remove "thinking..."
    const thinkingEl = document.getElementById("thinking");
    if (thinkingEl) thinkingEl.remove();

    chatbox.innerHTML += `<div class="p-2 mb-2 bg-success text-white rounded"><b>AI:</b> ${data.answer}</div>`;
  } catch (err) {
    const thinkingEl = document.getElementById("thinking");
    if (thinkingEl) thinkingEl.remove();
    chatbox.innerHTML += `<div class="p-2 mb-2 bg-danger text-white rounded"><b>Error:</b> ${err}</div>`;
  }

  document.getElementById("userInput").value = "";
  chatbox.scrollTop = chatbox.scrollHeight;
}

// Send message on Enter key
document.getElementById("userInput").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    askQuestion();
    e.preventDefault();
  }
});
</script>
{% endblock %}
